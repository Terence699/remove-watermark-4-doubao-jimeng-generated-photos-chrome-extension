# 豆包即梦图片去水印下载 Chrome 插件

## 项目目标

开发一个 Chrome 浏览器扩展，帮助用户在豆包（https://www.doubao.com）、即梦（https://jimeng.jianying.com）和即梦国际版-Dreamina（https://dreamina.capcut.com）网页上下载图片时，自动去除图片上的水印，并保存为本地图片。

## 主要功能

1. **多网站支持**：自动检测豆包、即梦和Dreamina网站，使用不同的图片选择器。
2. **智能显示**：只在大图模式下显示下载按钮，列表页面不显示。
3. **自动去水印**：针对不同网站采用不同的水印去除策略。
4. **优雅交互**：
   - 豆包：紫蓝色渐变按钮
   - 即梦：天蓝色渐变按钮
   - Dreamina：橙红色渐变按钮
5. **智能清理**：按钮会根据图片状态自动显示/隐藏，不会残留。
6. **直接下载**：处理后的图片直接下载到本地，无需跳转新标签页。

## 使用方法

1. 安装本扩展后，访问豆包、即梦或Dreamina网页。
2. 点击打开大图模式。
3. 在图片右上角会出现"去水印下载"按钮。
4. 点击按钮即可自动下载去除水印后的图片。

## 技术实现

- **Manifest V3**：使用最新的Chrome扩展规范。
- **最小权限原则**：仅使用必要的host_permissions，无需activeTab或scripting权限。
- **Content Scripts**：智能注入页面，符合Chrome Web Store政策要求。
- **自适应选择器**：使用模糊匹配技术，自动适应网站结构变化，支持CSS类名和数据属性的模式匹配。
- **图片处理**：
  - **固定区域策略**：基于用户偏好，固定处理左上角区域，确保100%覆盖"AI生成"水印。
  - **智能混合滤波**：结合中值滤波和加权平均，根据像素位置动态调整处理强度。
  - **自然边界算法**：使用正弦波噪声生成不规则边界，15像素平滑渐变，消除矩形感。
  - **高斯加权采样**：4像素半径邻域采样，保持原始纹理特征，避免人工痕迹。
  - **纹理保持技术**：边缘区域保守处理，中心区域彻底去除，实现自然过渡。
  - 豆包：Canvas处理，固定左上角水印去除，自然边界处理。
  - 即梦：fetch直接下载 + webp转png + 固定区域处理。
- **按钮管理**：使用WeakSet和Map进行智能的按钮生命周期管理。
- **响应式设计**：支持不同分辨率，按钮自动跟随图片位置。
- **智能适配**：模糊匹配选择器，自动适应网站CSS类名和属性变化。

## 权限说明

本扩展严格遵循最小权限原则，仅请求必要权限：

- **host_permissions**：
  - `https://www.doubao.com/*` - 访问豆包网站
  - `https://jimeng.jianying.com/*` - 访问即梦网站
  - `https://dreamina.capcut.com/*` - 访问Dreamina网站
- **无需其他权限**：不使用activeTab、scripting等可能被认为过度的权限

## 图标设计

### 设计理念

- **极简主义**：简洁的几何形状，现代化设计
- **高级感**：渐变色彩，微妙的光影效果
- **功能性**：图片框架 + 下载箭头，直观表达功能

### 设计元素

- **背景**：紫蓝渐变圆形，呼应按钮配色
- **图片框架**：白色描边矩形，圆角设计
- **风景示意**：简化的山峦和太阳，表示图片内容
- **下载箭头**：现代化的下载图标
- **动画效果**：`icon.svg`包含微妙的清洁效果动画

### 文件说明

- `icon.svg`：主设计文件（128x128，包含动画）
- `icon16.png`、`icon48.png`、`icon128.png`：静态版本，用于Chrome扩展

## 文件结构

```
├── manifest.json          # Chrome扩展配置
├── contentScript.js        # 主要功能脚本
├── icon.svg              # 源图标文件（动画版）
├── icon16.png            # 16x16图标
├── icon48.png            # 48x48图标
├── icon128.png           # 128x128图标
├── privacy-policy.md     # 隐私政策
└── README.md             # 项目说明
```

## 安装方法

### 用户安装（生产环境）

1. 打开Chrome浏览器的扩展管理页面（chrome://extensions/）
2. 开启"开发者模式"
3. 点击"加载已解压的扩展程序"
4. 选择本项目文件夹

### 开发者安装（开发环境）

如需启用调试面板进行开发调试：

1. 编辑 `contentScript.js` 文件
2. 取消注释所有 `showDebugMessage()` 调用（搜索 `// 开发调试用，部署前注释掉`）
3. 重新加载扩展
4. 调试完成后，重新注释掉这些调用以避免用户看到调试面板

## 支持的网站

- ✅ **豆包**（doubao.com）：智能去水印，Canvas处理
- ✅ **即梦**（jimeng.jianying.com）：webp转换，直接下载
- ✅ **Dreamina**（dreamina.capcut.com）：智能去水印，Canvas处理

## 技术特色

- **零配置**：安装即用，无需用户设置
- **固定区域去水印**：基于用户偏好，固定处理左上角，避免复杂检测逻辑
- **自然处理效果**：不规则边界+平滑渐变，消除人工痕迹
- **优雅降级**：处理失败时自动下载原图
- **内存优化**：使用WeakSet避免内存泄漏
- **实时清理**：MutationObserver + 防抖机制
- **权限最小化**：符合Chrome Web Store最佳实践
- **开发友好**：内置调试面板，开发时可启用，部署时自动隐藏
- **自适应架构**：智能选择器系统，使用模糊匹配技术自动适应网站更新变化，支持CSS类名和数据属性的模式匹配

## 版本更新

### v1.2.3 (2025-07-24)
- 🔧 **Dreamina适配修复**：修复了Dreamina网站更新导致的下载按钮不显示问题
- 🎯 **选择器优化**：为Dreamina实现模糊匹配选择器，支持新的CSS类名(`image-kLinqp`)和数据属性(`ai-generated-image-detail-card`)
- 🔍 **检测增强**：增强Dreamina大图模式检测逻辑，添加多重检测策略：
  - 主要检测：模态容器 + 尺寸 > 400x400
  - 降级检测1：数据属性包含"detail"或"card" + 尺寸 > 300x300
  - 降级检测2：大尺寸图片 > 500x500
- 📊 **调试改进**：为Dreamina添加详细的调试日志，便于问题诊断和维护
- 🛡️ **鲁棒性提升**：提高插件对Dreamina网站结构变化的适应能力，使用模糊匹配技术

### v1.2.2 (2025-06-27)

- 🔧 **即梦适配修复**：修复了即梦网站更新导致的插件失效问题
- 🎯 **选择器优化**：将硬编码的CSS类名改为模糊匹配，提高兼容性
- 🔍 **检测增强**：优化大图模式检测逻辑，降低尺寸要求并添加备用检测
- 📊 **调试改进**：增加详细的调试日志，便于问题诊断和维护
- 🛡️ **鲁棒性提升**：提高插件对网站结构变化的适应能力

### v1.2.1 (2025-06-23)

- 增加了对即梦国际版dreamina的支持

### v1.2.0 (2025-06-18)

- 🎯 **策略简化**：基于用户反馈，移除复杂的水印检测算法，改为固定处理左上角区域策略。
- 🔧 **算法优化**：
  - **固定区域处理**：每次都处理左上角(3,3,220x90)区域，确保100%覆盖"AI生成"水印
  - **智能混合滤波**：结合中值滤波和加权平均，边缘区域更保守，中心区域更彻底
  - **自然边界处理**：使用正弦波噪声生成不规则边界，15像素平滑渐变，彻底消除矩形感
  - **高斯加权采样**：4像素半径的邻域采样，保持原始纹理特征
- 🎨 **视觉优化**：
  - **无白色方块**：完全移除可能产生白色方块的智能修复算法
  - **自然过渡**：平滑步函数渐变，随机强度变化(0.8-1.2倍)
  - **纹理保持**：边缘区域保留更多原始图像特征，减少人工痕迹
- 🚀 **性能提升**：4次迭代+自然边界处理，处理速度更快，效果更自然
- 📊 **用户体验**：简化日志输出，移除复杂的检测评分，专注处理效果
- 🔧 **开发优化**：调试面板默认隐藏，开发时可启用，避免干扰用户体验

### v1.1.0 (2025-06-18)

- 🚀 **重大更新**：实现智能四角水印自动检测系统，彻底解决水印位置变化问题。
- 🔍 **智能检测**：自动分析图片四个角落，使用像素分析算法检测水印存在性。
- 🎯 **增强型去除**：对检测到的水印区域使用多迭代、大核心的中值滤波算法进行强力去除。
- 🎨 **内容感知修复**：开发了全新的智能背景修复系统，取代简单的颜色填充。通过分析周围背景纹理，克隆相似像素，旨在彻底杜绝"白色方块"问题，实现无痕修复。
- 🛡️ **分层处理策略**：建立"强力去除 → 残留分析 → 智能修复 → 降级填充"的多层次、高鲁棒性处理流程。
- 📊 **可视化调试**：新增实时调试面板，显示水印检测评分和处理过程。

### v1.0.3 (2025-06-11)

- 🐞 **BUG修复**：修复了在特定场景下，点击下载按钮后仍会下载带水印图片的问题。
- 🔧 **逻辑优化**：重构了下载流程的判断逻辑，确保始终针对无水印版本进行操作。

### v1.0.2 (2025-05-31)

- 🚀 **功能增强**：适配了豆包网站新版的水印，优化水印检测与去除算法。
- 🛠️ **细节修复**：提升了在特定分辨率下的图片处理稳定性。

### v1.0.1 (2025-05-30)

- 🔧 **权限优化**：移除不必要的activeTab和scripting权限
- 🗑️ **代码清理**：移除空的Service Worker
- ✅ **合规性**：符合Chrome Web Store权限政策要求

### v1.0.0 (2025-05-29)

- 🎉 **初始版本**：支持豆包和即梦两个网站
- 🎨 **优雅UI**：现代化按钮设计和交互
- 🧠 **智能检测**：大图模式自动识别
- 🎯 **智能去水印**：自动分析并移除水印，提升鲁棒性。

## 故障排除

### 下载按钮不显示
1. **检查网站支持**：确认当前网站是豆包、即梦或Dreamina
2. **确认大图模式**：只有在大图/详情页面才会显示按钮，列表页面不会显示
3. **刷新页面**：有时需要刷新页面让扩展重新检测
4. **查看控制台**：按F12打开开发者工具，查看Console中的调试信息
5. **重新加载扩展**：在chrome://extensions/中重新加载扩展

### 下载失败
1. **网络问题**：检查网络连接是否正常
2. **图片权限**：某些图片可能有访问限制
3. **浏览器设置**：检查浏览器下载设置和权限

### 水印去除效果不理想
- 当前版本专门针对左上角"AI生成"水印优化
- 如果水印位置不同，可能效果有限
- 处理失败时会自动下载原图作为备选

## 后续优化建议

- 支持更多AI图片生成网站
- 增加自定义水印去除区域设置
- 添加Side Panel管理下载历史
- 支持批量下载功能
- 进一步优化自然边界算法
- 添加处理效果预览功能
- 实现自动选择器更新机制
- 增加网站兼容性监控和报告

---

**开发者**：Terence Yuan
**版本**：1.2.3
**许可证**：MIT
